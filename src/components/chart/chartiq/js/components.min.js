!function(t,e){"function"==typeof define&&define.amd?define(["componentUI"],e):"object"==typeof exports?module.exports=e(require("./componentUI")):e(t)}(this,function(t){var w=t.CIQ,e={prototype:Object.create(w.UI.BaseComponent)};e.prototype.activeAttributes=null,e.prototype.createdCallback=function(){w.UI.BaseComponent.createdCallback.apply(this),this.activeAttributes={}},e.prototype.attachedCallback=function(){if(!this.attached){this.isDialog=!0,w.UI.BaseComponent.attachedCallback.apply(this);var e=this;this.node.stxtap(function(t){e.tap(t)}),$("cq-ui-manager").each(function(){this.registerForResize(e),e.uiManager=this})}},e.prototype.detachedCallback=function(){var t=this;$("cq-ui-manager").each(function(){this.unregisterForResize(t)})},e.prototype.addActiveAttribute=function(t){this.activeAttributes[t]=!0},e.prototype.tap=function(t){this.uiManager.topMenu()!==this&&t.currentTarget.active||t.stopPropagation()},e.prototype.resize=function(){this.params&&this.params.x?this.stxContextMenu():this.center(),$(this.node).find("cq-scroll").each(function(){this.resize()})},e.prototype.stxContextMenu=function(){var t=this.node.parent();"BODY"==t[0].tagName&&(t=$(window));var e=t.guaranteedWidth(),a=t.guaranteedHeight(),i=this.node.outerWidth(),o=this.node.outerHeight(),n=this.params.x,r=this.params.y,s=!1;this.node.find("cq-menu.stxMenuActive:has(.context-menu-right)").each(function(){var t=$(this),e=t.find(".context-menu-right"),a=t.nextAll().length+1;i+=e.outerWidth(),o+=e.outerHeight()-t.outerHeight()*a,s=!0}),e<n+i&&(n=e-i),a<r+o&&(r=a-o),r<0&&(r=0),s&&(this.params.x=n,this.params.y=r),this.node.css({top:r+"px",left:n+"px"})},e.prototype.center=function(){var t=this.node.parent();"BODY"==t[0].tagName&&(t=$(window));var e=t.guaranteedWidth(),a=t.guaranteedHeight(),i=this.node.outerWidth(),o=this.node.outerHeight(),n=e/2-i/2,r=a/2-o/2;n<0&&(n=0),2*o<a&&a/3<r+o/2&&(r=a/3-o/2),r<0&&(r=0),this.node.css({top:r+"px",left:n+"px"})},e.prototype.open=function(t){this.uiManager.openMenu(this,t)},e.prototype.close=function(){this.uiManager.closeMenu(this)},e.prototype.hide=function(){if(!$(this).find(":invalid").length){for(var t in this.node.children().each(function(){"function"==typeof this.hide&&this.hide()}),this.active=!1,this.uiManager.overlay&&this.uiManager.overlay.removeAttrBetter("cq-active"),this.activeAttributes)this.node.removeAttrBetter(t);this.activeAttributes={},$(this).find("input").each(function(){this==document.activeElement&&this.blur()})}},e.prototype.show=function(e){(this.params=e)||(e=this.params={});var a=this;if(!this.uiManager.overlay&&!e.bypassOverlay){this.uiManager.overlay=$("<cq-dialog-overlay></cq-dialog-overlay>");var t=e.context||w.UI.getMyContext(this);t&&t.node.append(this.uiManager.overlay)}setTimeout(function(){for(var t in a.uiManager.overlay&&!e.bypassOverlay&&a.uiManager.overlay.attrBetter("cq-active"),a.activeAttributes["cq-active"]=!0,a.activeAttributes)a.node.attrBetter(t);a.resize(),a.active=!0})},w.UI.Dialog=document.registerElement("cq-dialog",e);var a={prototype:Object.create(w.UI.DialogContentTag)};a.prototype.save=function(){var i=this.node.find("input").val();if(i){var o=!1,n=this.context.stx.exportLayout();$("cq-views").each(function(){for(var t,e=this.params.viewObj,a=0;a<e.views.length&&(t=e.views[a],i!=w.first(t));a++);a==e.views.length&&((t={})[i]={},e.views.push(t)),t[i]=n,delete t[i].candleWidth,this.renderMenu(),o||(o=!0,this.params.nameValueStore.set("stx-views",e.views))}),this.close()}},w.UI.ViewDialog=document.registerElement("cq-view-dialog",a);var i={prototype:Object.create(w.UI.BaseComponent)};i.prototype.top=function(){this.scrollTop=0,this.node.perfectScrollbar&&this.node.perfectScrollbar("update")},i.prototype.scrollToElement=function(t){var e=this.clientHeight,a=this.scrollTop,i=t.offsetTop+t.clientHeight;t.offsetTop>a&&i<e+a||(this.scrollTop=Math.max(i-e,0),this.node.perfectScrollbar&&this.node.perfectScrollbar("update"))},i.prototype.resize=function(){var t=this.node;if(!t.parents(".sharing").length&&void 0===t.attr("cq-no-resize")){void 0!==t.attr("cq-no-maximize")&&(this.noMaximize=!0);var a=t[0].getBoundingClientRect(),e=t.prop("reduceMenuHeight")||45,i=$(window).height();if(i){var o=i-a.top-e,n=t.parents(".stx-holder,.stx-subholder,.chartContainer");n.length&&n.each(function(){var t=$(this),e=t[0].getBoundingClientRect().top+t.height();o=Math.min(o,e-a.top-5)});for(var r=t.nextAll(),s=0;s<r.length;s++){var c=$(r[s]);c.is(":visible")&&(o-=c.height())}this.noMaximize||t.css({height:o+"px"}),t.css({"max-height":o+"px"}),t.perfectScrollbar&&t.perfectScrollbar("update")}}},i.prototype.createdCallback=function(){w.UI.BaseComponent.createdCallback.apply(this),this.node=$(this),this.node.css({"overflow-y":"auto"})},i.prototype.attachedCallback=function(){if(!this.attached){w.UI.BaseComponent.attachedCallback.apply(this),this.uiManager=$("cq-ui-manager"),0<this.uiManager.length&&(this.uiManager=this.uiManager[0]);var t=this.node;t.perfectScrollbar&&t.perfectScrollbar({suppressScrollX:!0}),void 0===t.attr("cq-no-claim")&&this.addClaim(this),this.addEventListener(w.wheelEvent,function(t){t.stopPropagation()});var e=this;w.addResizeListener(this,function(){e.resize()}),this.resize(),this.attached=!0}},i.prototype.keyStroke=function(t,e,a){var i=this.node;if(!i.is(":trulyvisible"))return!1;switch(e){case"ArrowUp":case"ArrowDown":case"Enter":case" ":case"Up":case"Down":case"Spacebar":break;default:return!1}var o=i.find("cq-item");if(o.length){var n=i.find("cq-item[cq-focused]");if(" "==e||"Spacebar"==e||"Enter"==e)return!(!n.length||!n[0].selectFC||(n[0].selectFC.call(n,a),0));if(!n.length)return $(o[0]).attr("cq-focused","true"),this.scrollToElement(o[0]),!0;o.removeAttr("cq-focused");for(var r=0;r<o.length&&o[r]!==n[0];r++);return"ArrowUp"!=e&&"Up"!=e||--r<0&&(r=0),"ArrowDown"!=e&&"Down"!=e||++r>=o.length&&(r=o.length-1),$(o[r]).attr("cq-focused","true"),this.scrollToElement(o[r]),!0}},i.prototype.focused=function(){var t=this.node.find("cq-item[cq-focused]");return t.length?t[0]:null},w.UI.Scroll=document.registerElement("cq-scroll",i);var o={prototype:Object.create(w.UI.ModalTag)};o.prototype.attachedCallback=function(){this.attached||(w.UI.ModalTag.attachedCallback.apply(this),this.nameValueStore=new w.NameValueStore,this.attached=!0)},o.prototype.setSleepAmount=function(t,e){this.sleepAmount={units:t,unitType:e}},o.prototype.setNameValueStore=function(t){this.nameValueStore=t},o.prototype.makeMarker=function(){this.markerExists||(new w.Marker({stx:this.context.stx,xPositioner:"none",label:"advertisement",permanent:!0,node:this.node[0]}),this.markerExists=!0)},o.prototype.show=function(t,e){if(this.selector&&this.node.find(this.selector).removeClass("ciq-show"),this.selector=t,!this.selector){var a=this.node.find("div:first-of-type");this.selector="."+a.attr("class")}this.ignoreSleep=e;var i=this;function o(){i.makeMarker(),i.node.css({display:"block"}),i.node.find(i.selector).addClass("ciq-show"),i.node.css({height:"0px"}),setTimeout(function(){i.node.css({height:i.node[0].scrollHeight+"px"})},0)}e?o():this.nameValueStore.get("cq-advertisement",function(t,e){if(!t){e&&"object"==typeof e||(e={});var a=e[i.selector];a&&a>Date.now()||o()}})},o.prototype.close=function(){this.node.css({display:"none"});var r=this;this.nameValueStore.get("cq-advertisement",function(t,e){if(!t){var a=new Date;r.sleepAmount||(r.sleepAmount={units:1,unitType:"day"});var i=r.sleepAmount.units,o=r.sleepAmount.unitType;"minute"==o?a.setMinutes(a.getMinutes()+i):"hour"==o?a.setHours(a.getHours()+i):"day"==o?a.setDate(a.getDate()+i):"week"==o?a.setDate(a.getDate()+7*i):"month"==o&&a.setMonth(a.getMonth()+i);var n=a.getTime();e&&"object"==typeof e||(e={}),e[r.selector]=n,r.nameValueStore.set("cq-advertisement",e)}})},o.prototype.watchForRemoteClose=function(t){t||(t=1e3);var i=this;setInterval(function(){"none"!=i.node.css("display")&&i.nameValueStore.get("cq-advertisement",function(t,e){if(!t){e&&"object"==typeof e||(e={});var a=e[i.selector];a&&a>Date.now()&&i.close()}})},t)},w.UI.Advertisement=document.registerElement("cq-advertisement",o);var n={prototype:Object.create(w.UI.ModalTag)};n.prototype.insert=function(t,e){var a=w.UI.makeFromTemplate(this.template);return new w.Marker({stx:t,node:a[0],xPositioner:"none",yPositioner:"none",label:"attribution",panelName:e}),a},n.prototype.attachedCallback=function(){this.attached||(w.UI.ModalTag.attachedCallback.apply(this),this.attached=!0)},n.prototype.setContext=function(t){this.template=this.node.find("template");var r=this.insert(t.stx,"chart"),s=this;this.addInjection("append","createDataSet",function(){var t,e;this.chart.attribution&&((t=s.messages.sources[this.chart.attribution.source])||(t=""),(e=s.messages.exchanges[this.chart.attribution.exchange])||(e=""),t+e!=r.attr("lastAttrib")&&(r.find("cq-attrib-source").html(t),r.find("cq-attrib-quote-type").html(e),w.I18N.translateUI(null,r[0]),r.attr("lastAttrib",t+e)));t:for(var a in this.layout.studies){var i=this.layout.studies[a].type;if(s.messages.sources[i]){for(var o=0;o<this.markers.attribution.length;o++)if(this.markers.attribution[o].params.panelName==this.layout.studies[a].panel)continue t;if(!this.panels[a])continue;(t=s.messages.sources[i])||(t=""),(e=s.messages.exchanges[i])||(e="");var n=s.insert(this,a);n.find("cq-attrib-source").html(t),n.find("cq-attrib-quote-type").html(e),w.I18N.translateUI(null,n[0])}}})},n.prototype.messages={sources:{simulator:"Simulated data.",demo:"Demo data.",xignite:'<a target="_blank" href="https://www.xignite.com">Market Data</a> by Xignite.',fis_mm:'<a target="_blank" href="https://www.fisglobal.com/">Market Data</a> by FIS MarketMap.',Twiggs:'Formula courtesy <a target="_blank" href="https://www.incrediblecharts.com/indicators/twiggs_money_flow.php">IncredibleCharts</a>.'},exchanges:{RANDOM:"Data is randomized.","REAL-TIME":"Data is real-time.",DELAYED:"Data delayed 15 min.",BATS:"BATS BZX real-time.",EOD:"End of day data."}},w.UI.Attribution=document.registerElement("cq-attribution",n);var r={prototype:Object.create(w.UI.ModalTag)};r.prototype.attachedCallback=function(){this.attached||(w.UI.ModalTag.attachedCallback.apply(this),this.attached=!0)},r.prototype.setContext=function(t){var e=this;w.UI.observe({obj:e.context.stx.chart,member:"symbolObject",action:"callback",value:function(){e.context.stx.currentQuote()&&(e.previousClose=e.context.stx.currentQuote().iqPrevClose)}}),this.initialize()},r.prototype.begin=function(){var t=this;this.addInjection("append","createDataSet",function(){t.update()}),this.update()},r.prototype.initialize=function(t){this.params=t||{},void 0===this.params.autoStart&&(this.params.autoStart=!0),this.marker=null,this.params.autoStart&&this.begin()},r.prototype.previousClose=null,r.prototype.update=function(){var t=this.context.stx,e=$(this);t.chart.dataSet&&t.chart.dataSet.length?e.addClass("stx-show"):e.removeClass("stx-show");var a=e.find("cq-symbol"),i=e.find("cq-symbol-description"),o=e.find("cq-current-price"),n=e.find("cq-todays-change"),r=e.find("cq-todays-change-pct"),s=e.find("cq-chart-price"),c=e.find("cq-change"),l=this.node.truthyAttr("cq-browser-tab"),h=s.length,p=t.chart.symbol,u=t.chart.symbolDisplay,d=t.internationalizer,m=!1;if(a.textBetter(p),t.isHistoricalModeSet)return o.textBetter(""),void c.css({display:"none"});var f,v="",g=0,y="",b=t.currentQuote();if((f=b?b.Close:"")&&h){var x=parseFloat(o.text());o.textBetter(t.formatYAxisPrice(f,t.chart.panel))&&(m=!0,void 0!==o.attr("cq-animate")&&w.UI.animatePrice(o,f,x))}if(i.textBetter(u||p),(h||l)&&p&&m){var C=this.previousClose?this.previousClose:b?b.iqPrevClose:null;b&&C?(g=(v=w.fixPrice(b.Close-C))/C*100,y=C<=0||b.Close<0?"N/A":d?d.percent2.format(g/100):g.toFixed(2)+"%",c.css({display:"block"})):c.css({display:"none"});var q=Math.abs(v);q&&n.textBetter(t.formatYAxisPrice(q,t.chart.panel)),r.length&&r.textBetter(y),""!==y&&0<v?s.removeClass("stx-down").addClass("stx-up"):""!==y&&v<0?s.removeClass("stx-up").addClass("stx-down"):s.removeClass("stx-down").removeClass("stx-up"),this.title=p+" \u200b \u200b "+f+" \u200b \u200b \u200b ",0<v?this.title+="\u25b2 "+q:v<0&&(this.title+="\u25bc "+q),l&&(document.title=this.title)}},w.UI.ChartTitle=document.registerElement("cq-chart-title",r);var s={prototype:Object.create(w.UI.ContextTag)};s.prototype.createdCallback=function(){w.UI.ContextTag.createdCallback.apply(this)},s.prototype.attachedCallback=function(){if(!this.attached){w.UI.ContextTag.attachedCallback.apply(this),this.attached=!0;var t=this;$(this).stxtap(function(){t.runMethod()})}},s.prototype.runMethod=function(){var t=this.node.attr("cq-selector"),e=this.node.attr("cq-method"),a=this;$(t).each(function(){this[e]&&this[e].call(this,{context:a.context,caller:a})})},w.UI.Clickable=document.registerElement("cq-clickable",s);var c={prototype:Object.create(w.UI.BaseComponent)};c.prototype.attachedCallback=function(){if(!this.attached){var t=this;$(this).stxtap(function(){t.tap()}),w.UI.BaseComponent.attachedCallback.apply(this),this.attached=!0}},c.prototype.tap=function(){w.UI.containerExecute(this,"close")},w.UI.Close=document.registerElement("cq-close",c);var l={prototype:Object.create(w.UI.ModalTag)};l.prototype.attachedCallback=function(){this.attached||(w.UI.ModalTag.attachedCallback.apply(this),this.attached=!0,this.swatchColors=["#8ec648","#00afed","#ee652e","#912a8e","#fff126","#e9088c","#ea1d2c","#00a553","#00a99c","#0056a4","#f4932f","#0073ba","#66308f","#323390"],this.loading=[])},l.prototype.removeSeries=function(t,e){this.context.stx.removeSeries(t)},l.prototype.pickSwatchColor=function(){var t=$(this),e=this.context.stx,a=t.find("cq-swatch");if(a.length){var i=a[0].style.backgroundColor,o={};for(var n in e.chart.series){var r=e.chart.series[n];r.parameters.isComparison&&(o[r.parameters.color]=!0)}if(""===i||o[i])for(var s=0;s<this.swatchColors.length;s++)if(!o[this.swatchColors[s]])return void(a[0].style.backgroundColor=this.swatchColors[s])}},l.prototype.renderLegend=function(){var t=$(this).find("cq-comparison-key").cqvirtual(),e=this.context.stx,a=e.currentQuote();for(var i in e.chart.series){var o=e.chart.series[i];if(o.parameters.isComparison){var n=w.UI.makeFromTemplate(this.template),r=n.find("cq-comparison-swatch"),s=n.find("cq-comparison-label"),c=n.find("cq-comparison-description"),l=n.find("cq-comparison-price"),h=n.find("cq-comparison-loader"),p=n.find(".ciq-close");r.css({"background-color":o.parameters.color}),s.text(e.translateIf(o.display)),c.text(e.translateIf(o.description)),n.attr("cq-symbol",i);var u=o.parameters.symbol;if(l.length&&a&&null!==u){var d=a[u];"object"==typeof d&&(d=a[u].Close),l.text(e.padOutPrice(d))}this.loading[o.parameters.symbolObject.symbol]?h.addClass("stx-show"):h.removeClass("stx-show"),o.parameters.error&&n.attr("cq-error",!0),o.parameters.permanent?p.hide():p.stxtap(function(t,e,a){return function(){t.nomore=!0,a.parameters.permanent||t.removeSeries(e,a),t.modalEnd()}}(this,i,o)),t.append(n)}}t.cqrender(),this.pickSwatchColor()},l.prototype.updatePrices=function(){var t,e=this.context.stx,a=e.isHistoricalModeSet,i=e.currentQuote();if(i)for(var o in e.chart.series){t||(t=this.node.find("cq-comparison-key"));var n=t.find('cq-comparison-item[cq-symbol="'+o+'"] cq-comparison-price');if(n.length){var r=parseFloat(n.text()),s=i[e.chart.series[o].parameters.symbol],c=e.chart.series[o].parameters.field||"Close";if(s&&(s[c]||0===s[c])&&(s=s[c]),!s&&0!==s&&e.chart.series[o].lastQuote&&(s=e.chart.series[o].lastQuote[c]),n.text(e.padOutPrice(a?"":s)),a)return;void 0!==n.attr("cq-animate")&&w.UI.animatePrice(n,s,r)}}},l.prototype.startPriceTracker=function(t){var e=this;this.addInjection("append","createDataSet",function(){t&&e.updatePrices(),this.chart.dataSet&&this.chart.dataSet.length?e.node.attrBetter("cq-show"):e.node.removeAttrBetter("cq-show")})},l.prototype.position=function(){var n=this.context.stx,t=n.barFromPixel(n.cx);this.tick=n.tickFromPixel(n.cx);var r=n.chart.xaxis[t],s=this;this.tick!=this.prevTick&&(this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(function(){var t;for(var e in s.timeout=null,n.chart.series){t||(t=s.node.find("cq-comparison-key"));var a=t.find('cq-comparison-item[cq-symbol="'+e+'"] cq-comparison-tick-price');if(a.textBetter(""),a.length&&r&&r.data){var i=n.chart.series[e].parameters.symbol;a.textBetter(n.padOutPrice(r.data[i]));var o=r.data[i];null!==o&&("object"==typeof o&&(o=o.Close),a.textBetter(n.padOutPrice(o)))}}},0)),this.prevTick=this.tick},l.prototype.startTickPriceTracker=function(){var t;this.prevTick=null,this.addInjection("prepend","headsUpHR",(t=this,function(){t.position()}))},l.prototype.setContext=function(t){var e=this.context.stx.chart;this.node.attr("cq-show","true"),this.configureUI();var a=this;w.UI.observe({obj:e.series,action:"callback",value:function(){a.renderLegend()}}),this.context.stx.append("modifySeries",function(){a.renderLegend()});var i=w.UI.makeFromTemplate(this.template);this.startPriceTracker(i.find("cq-comparison-price").length),i.find("cq-comparison-tick-price")&&this.startTickPriceTracker()},l.prototype.selectItem=function(t,e){var a=this,i=this.node.find("cq-swatch"),o="auto",n=null,r=1;if(i[0]){var s=i[0].style;o=s.backgroundColor,n=s.borderTopStyle,r=s.width||1}for(var c=t.stx,l={name:"_generic_series",symbolObject:e,isComparison:this.loading[e.symbol]=!0,color:o,pattern:n,width:r||1,data:{useDefaultQuoteFeed:!0},forceData:!0},h=c.getSeries({symbolObject:e}),p=0;p<h.length;p++)if(h[p].parameters.isComparison)return void(this.loading[e.symbol]=!1);t.stx.chart.symbol.toLowerCase()!==e.symbol.toLowerCase()&&0<e.symbol.trim().length?c.addSeries(e.symbol,l,function(t,e){t&&(e.parameters.error=!0),a.loading[e.parameters.symbolObject.symbol]=!1,a.renderLegend()}):this.loading[e.symbol]=!1},l.prototype.configureUI=function(){var t=this.node,e=t.find("cq-accept-btn");this.template=t.find("*[cq-comparison-item]");var a=t.find("cq-swatch").attr("cq-colors");a&&(this.swatchColors=a.split(","));for(var i=0;i<this.swatchColors.length;i++)this.swatchColors[i]=w.convertToNativeColor(this.swatchColors[i]);var o,n=t.find("cq-lookup");n.length&&n[0].setCallback((o=this,function(){o.selectItem.apply(o,arguments)})),e.stxtap(function(t){n[0].forceInput(),t.stopPropagation()}),t.find("input").stxtap(function(){this.focus()})},w.UI.Comparison=document.registerElement("cq-comparison",l);var h={prototype:Object.create(w.UI.DialogContentTag)};h.prototype.add=function(){var t=$(this).find("[cq-custom-fibonacci-setting] input").val();if(t&&(t=parseFloat(t)/100,!isNaN(t))){for(var e,a,i=this.context.stx.currentVectorParameters.fibonacci.fibs||[],o=0;o<i.length;o++)if((e=i[o]).level>t){(a=w.clone(e)).level=t,a.display=!0,i.splice(o,0,a);break}a||(e=i.length?w.clone(i[0]):{color:"auto",parameters:{pattern:"solid",opacity:.25,lineWidth:1}},(a=w.clone(e)).level=t,a.display=!0,i.push(a)),this.open()}},h.prototype.setChangeEvent=function(t,e,n){var r=this;t.change(function(){var t=r.context.stx.currentVectorParameters,e=t.vectorType;if(t.fibonacci&&"fibtimezone"!=e){var a=t.fibonacci.fibs||[];if("checkbox"==this.type)for(var i=0;i<a.length;i++){var o=a[i];o.level===n&&(o.display=!!this.checked)}}})},h.prototype.open=function(t){w.UI.DialogContentTag.open.apply(this,arguments),t&&(this.opener=t.caller);var e,a=this.context.stx.currentVectorParameters,i=a.vectorType,o=$(this);if(a.fibonacci&&"fibtimezone"!=i){o.find(".title").text("Fibonacci Settings");var n=a.fibonacci.fibs||[];(e=o.find("cq-fibonacci-settings")).emptyExceptTemplate();for(var r=0;r<n.length;r++){var s=n[r];if(!("fibarc"===i&&s.level<0)){var c=w.UI.makeFromTemplate(this.node.find("template"),e),l=100*s.level;c.find(".ciq-heading").text(l.toFixed(1)+"%");var h=c.find("input");s.display&&h.prop("checked",!0),this.setChangeEvent(h,"fib",s.level),c.find(".stx-data").append(h)}}}else o.find(".title").text("Settings"),(e=o.find("cq-fibonacci-settings")).emptyExceptTemplate();$(this).find("[cq-custom-fibonacci-setting] input").val("")},h.prototype.close=function(){var t;"function"==typeof Event?t=new Event("change",{bubbles:!0,cancelable:!0}):(t=document.createEvent("Event")).initEvent("change",!0,!0),this.opener&&this.opener.dispatchEvent(t),w.UI.DialogContentTag.close.call(this)},w.UI.FibSettingsDialog=document.registerElement("cq-fib-settings-dialog",h);var p={prototype:Object.create(w.UI.DialogContentTag)};p.prototype.open=function(t){w.UI.DialogContentTag.open.apply(this,arguments);var e=this.node.find("cq-languages");e.emptyExceptTemplate();var a=this.node.find("template"),i=w.I18N.languages;if(i)for(var o in i){var n=w.UI.makeFromTemplate(a,e);n.find("cq-language-name").text(i[o]),n.find("cq-flag").attr("cq-lang",o),n.stxtap(r(o))}function r(e){return function(){w.UI.contextsForEach(function(){var t=this.stx;t.preferences.language=e,t.changeOccurred("preferences"),w.I18N.localize(t,e),t.draw()})}}},p.prototype.close=function(){$("cq-language-dialog").closest("cq-dialog,cq-menu").each(function(){this.close()})},w.UI.LanguageDialog=document.registerElement("cq-language-dialog",p);var u={prototype:Object.create(w.UI.ContextTag)};u.prototype.setContext=function(t){this.context.setLoader(this)},u.prototype.show=function(){$(this).addClass("stx-show")},u.prototype.hide=function(){$(this).removeClass("stx-show")},w.UI.Loader=document.registerElement("cq-loader",u);var d={prototype:Object.create(w.UI.ContextTag)};d.prototype.attachedCallback=function(){this.attached||(this.usingEmptyDriver=!1,w.UI.ContextTag.attachedCallback.apply(this),this.attached=!0,this.currentFilter=null,this.params={})},d.prototype.setContext=function(t){this.initialize()},d.prototype.attachDriver=function(t){this.driver=t},d.prototype.setCallback=function(t){this.params.cb=t},d.prototype.setDriver=function(t){this.params.driver=t},d.prototype.initialize=function(){var t=$(this);this.resultList=t.find("cq-scroll"),this.input=t.find("input"),this.input.length||(this.input=t.append($("<input type='hidden'>")),this.input[0].value="");var a=this;this.input.on("paste",function(t){var e=t.target;setTimeout(function(){a.acceptText(e.value,a.currentFilter)},0)});var i=t.find("cq-lookup-filters");i&&i.find("cq-filter").stxtap(function(){i.find("cq-filter").removeClass("true");var t=$(this);t.addClass("true");var e=t.find("translate");e.length?a.currentFilter=e.attr("original"):a.currentFilter=this.innerHTML,a.acceptText(a.input[0].value,a.currentFilter)}),void 0!==t.attr("cq-keystroke-claim")&&this.addClaim(this)},d.prototype.selectItem=function(t,e){this.params.cb&&this.params.cb(this.context,t,e)},d.prototype.open=function(){this.node.closest("cq-dialog,cq-menu").each(function(){this.open()})},d.prototype.close=function(){this.node.closest("cq-dialog,cq-menu").each(function(){this.close()})},d.prototype.isActive=function(){return""!==this.input[0].value},d.prototype.acceptText=function(t,e){var a=this;this.params.driver||(this.context.lookupDriver?this.setDriver(this.context.lookupDriver):(this.setDriver(new w.ChartEngine.Driver.Lookup),this.usingEmptyDriver=!0)),this.params.driver.acceptText(t,e,null,function(t){a.results(t)})},d.prototype.forceInput=function(){var t=this.input[0];this.selectItem({symbol:t.value}),w.blur(this.input),this.close(),t.value=""},d.prototype.keyStroke=function(t,e,a,i){if(i.ctrl||"Meta"==e||"Win"==e)return!1;var o=$(this).parents().addBack(),n=this.input[0],r=!1,s=document.activeElement===n;if(!s&&document.activeElement&&("INPUT"==document.activeElement.tagName||"TEXTAREA"==document.activeElement.tagName))return!1;var c=!1,l=!1;if(o.hasClass("stxMenuActive")&&(l=!0),(s||l)&&(c=!0),!c){if(void 0===this.node.attr("cq-keystroke-default"))return;if(!l&&this.uiManager.topMenu())return}if((" "===e||"Spacebar"===e)&&""===n.value)return!1;if(i.key&&1==i.key.length&&32<=a.which&&a.which<=222&&(s||(n.value=n.value+i.key),this.acceptText(n.value,this.currentFilter),r=!0),"Delete"==e||"Backspace"==e||"Del"==e){if(this.context.stx.anyHighlighted)return!1;n.value.length&&(window.getSelection().toString()?n.value="":(s||(n.value=n.value.substring(0,n.value.length-1)),n.value.length&&this.acceptText(n.value,this.currentFilter)),r=!0),"Backspace"==e&&(r=!0)}if("Escape"!==e&&"Esc"!==e||!l||(n.value="",this.close(),w.blur(n),r=!0),"Enter"===e&&""!==n.value&&this.isActive()){var h=this.node.find("cq-scroll");if((s=h.length&&h[0].focused())&&s.selectFC)s.selectFC.apply(s,{});else{var p=n.value;this.node.truthyAttr("cq-uppercase")&&(p=p.toUpperCase()),this.selectItem({symbol:p})}w.blur(this.input),this.close(),r=!(n.value="")}return r?(!this.usingEmptyDriver&&(n.value.length||"Escape"!=e&&"Esc"!=e&&"Enter"!=e&&s)?this.open():this.close(),!s||{allowDefault:!0}):void 0},d.prototype.results=function(t){function e(e,a){return function(t){w.blur(e.input),e.selectItem(a),e.input[0].value=""}}this.resultList.empty();for(var a=0;a<t.length;a++){for(var i=t[a],o="<cq-item>",n=0;n<i.display.length;n++)o+="<SPAN>"+i.display[n]+"</SPAN>";o+="</cq-item>";var r=$(o);this.resultList.append(r),r[0].selectFC=e(this,i.data),r.stxtap(r[0].selectFC)}var s=this.node.find("cq-scroll");s.length&&s[0].top()},w.UI.SymbolLookup=document.registerElement("cq-lookup",d);var m={prototype:Object.create(w.UI.ContextTag)};m.prototype.createdCallback=function(){w.UI.ContextTag.createdCallback.apply(this),this.redoButton=null,this.undostack=[],this.redostack=[],this.contexts=[]},m.prototype.attachedCallback=function(){if(!this.attached){w.UI.ContextTag.attachedCallback.apply(this),this.attached=!0;var t=this;$(this).stxtap(function(){t.undo()})}},m.prototype.setContext=function(t){this.manageContext(this.context);var e=this;this.addInjection("append","initializeChart",function(){e.undostack=[],e.redostack=[],e.clear()})},m.prototype.handleEvent=function(t,e,a){this.undostack.push({context:t,drawings:a.before}),this.redostack=[],this.setButtonStyle()},m.prototype.manageContext=function(e){this.addClaim(this);var a=this;e.stx.addEventListener("undoStamp",function(t){a.handleEvent(e,"undoStamp",t)}),this.contexts.push(e)},m.prototype.keyStroke=function(t,e,a,i){return"z"==e&&(i.ctrl||i.cmd)?(i.shift?this.redo():this.undo(),!0):"y"==e&&(i.ctrl||i.cmd)?(this.redo(),!0):void 0},m.prototype.undo=function(){for(var t=!1,e=0;e<this.contexts.length;e++)this.contexts[e].stx.activeDrawing&&(this.contexts[e].stx.undo(),t=!0);if(!t){var a=this.undostack.pop();if(a){var i=a.context;this.redostack.push({context:i,drawings:w.shallowClone(i.stx.drawingObjects)});var o=a.drawings;i.stx.drawingObjects=w.shallowClone(o),i.stx.changeOccurred("vector"),i.stx.draw()}this.setButtonStyle()}},m.prototype.redo=function(){var t=this.redostack.pop();if(t){var e=t.context;this.undostack.push({context:e,drawings:w.shallowClone(e.stx.drawingObjects)});var a=t.drawings;e.stx.drawingObjects=w.shallowClone(a),e.stx.changeOccurred("vector"),e.stx.draw()}this.setButtonStyle()},m.prototype.clear=function(t){this.setButtonStyle()},m.prototype.setButtonStyle=function(){this.undostack.length?$(this).attr("cq-active","true"):$(this).removeAttr("cq-active"),this.redoButton&&(this.redostack.length?$(this.redoButton).attr("cq-active","true"):$(this.redoButton).removeAttr("cq-active"))},w.UI.Undo=document.registerElement("cq-undo",m);var f={prototype:Object.create(w.UI.ContextTag)};f.prototype.attachedCallback=function(){this.attached||(w.UI.ContextTag.attachedCallback.apply(this),this.attached=!0)},f.prototype.pairUp=function(t){this.undo=$(t)[0];var e=this.undo.redoButton=this;$(this).stxtap(function(){e.undo.redo()})},w.UI.Redo=document.registerElement("cq-redo",f);var v={prototype:Object.create(w.UI.ContextTag)};v.prototype.set=function(t,e,a,i,o,n){var r=this;r.context.loader&&r.context.loader.show();var s={multiplier:e,base:a};i&&(s.periodicity={interval:i,period:o||1,timeUnit:n}),r.context.stx.setSpan(s,function(){r.context.loader&&r.context.loader.hide()})},w.UI.ShowRange=document.registerElement("cq-show-range",v);var g={prototype:Object.create(w.UI.ContextTag)};g.prototype.createdCallback=function(){var t,e;w.UI.ContextTag.createdCallback.apply(this,arguments),this.callbacks=[],window.addEventListener("resize",(e=(t=this).resizeMyself.bind(t),function(){setTimeout(e,0)}))},g.prototype.registerCallback=function(t){this.callbacks.push(t)},g.prototype.open=function(t){this.close();var e=this.node.find(t.selector);t.className?(e.addClass(t.className),e.each(function(){this.sidePanelActiveClass=t.className})):(e.attr(t.attribute,"true"),e.each(function(){this.sidePanelActiveAttribute=t.attribute})),this.node.attr("cq-active","true");var a=this;setTimeout(function(){a.resizeMyself()},0)},g.prototype.close=function(){this.node.removeAttr("cq-active"),this.node.children().each(function(){this.sidePanelActiveClass?$(this).removeClass(this.sidePanelActiveClass):$(this).removeAttr(this.sidePanelActiveAttribute)});var t=this;setTimeout(function(){t.resizeMyself()},0)},g.prototype.nonAnimatedWidth=function(){var a=0;return this.node.children().width(function(t,e){a+=e}),a},g.prototype.resizeMyself=function(){var a=0;this.node.children().width(function(t,e){a+=e}),this.node.css({width:a+"px"});for(var t=0;t<this.callbacks.length;t++)this.callbacks[t].call(this,a)},w.UI.SidePanel=document.registerElement("cq-side-panel",g);var y={prototype:Object.create(w.UI.DialogContentTag)};y.prototype.open=function(t){return this.drawing=t.drawing,w.UI.DialogContentTag.open.call(this,t)},w.UI.DrawingContext=document.registerElement("cq-drawing-context",y);var b={prototype:Object.create(w.UI.DialogContentTag)};w.UI.StudyContext=document.registerElement("cq-study-context",b);var x={prototype:Object.create(HTMLElement.prototype)};x.prototype.defaultColor=null,x.prototype.attachedCallback=function(){var e;this.attached||(this.node=$(this),$("cq-color-picker").length?this.node.stxtap((e=this,function(t){e.launchColorPicker(),t.stopPropagation()})):this.style.cursor="default",this.attached=!0)},x.prototype.getDefaultColor=function(){if(this.defaultColor)return this.defaultColor;var t=w.UI.getMyContext(this);return t?t.stx.defaultColor:"trasparent"},x.prototype.setColor=function(t,e){var a=$(this),i=w.getBackgroundColor(this.parentNode),o=w.hsl(i);t||(t="transparent");var n=t;"auto"==t?n=this.getDefaultColor():0===t.indexOf("rgba(")&&(n=(n.split(",").slice(0,3).join(",")+")").replace(/rgba/,"rgb"));var r=w.hsl(n);if(Math.abs(o[2]-r[2])<.2||w.isTransparent(t)){var s=w.chooseForegroundColor(i);a.css({border:"solid "+s+" 1px"})}else a.css({border:""});a.css({"background-color":n}),!1!==e&&w.UI.containerExecute(this,"setColor",t)},x.prototype.launchColorPicker=function(){var e,t=$(this),a=$("cq-color-picker")[0];a.callback=(e=this,function(t){e.setColor(t,null)});var i=this.node.attr("cq-overrides");i&&(i=i.split(",")),a.display({node:t,overrides:i}),this.colorPicker=a},w.UI.Swatch=document.registerElement("cq-swatch",x);var C={prototype:Object.create(w.UI.DialogContentTag)};C.prototype.applyChanges=function(){var t=this.context.stx;this.helper.update(t),t.changeOccurred("theme")},C.prototype.setValue=function(t,e,a){t[e]=a,this.applyChanges()},C.prototype.close=function(){this.helper.settings=this.revert,this.applyChanges(),w.UI.DialogContentTag.close.apply(this)},C.prototype.save=function(){var t=this.node.find("cq-action input").val(),e={settings:w.clone(this.helper.settings),name:t,builtIn:null};w.UI.contextsForEach(function(){this.stx.updateListeners("theme")});var a=this;$("cq-themes").each(function(){e.builtIn=this.currentLoadedBuiltIn,this.addCustom(e,a.initiatingMenu)}),w.UI.DialogContentTag.close.apply(this)},C.prototype.open=function(t){w.UI.DialogContentTag.open.apply(this,arguments);var e=t.themeName;this.initiatingMenu=t.initiatingMenu,this.context=t.context,this.helper=new w.ThemeHelper({stx:this.context.stx}),this.revert=w.clone(this.helper.settings);var n=this;function a(t,e,a,i){var o=n.node.find('cq-theme-piece[cq-piece="'+t+'"]');o.length&&(o[0].piece={obj:e,field:a},"color"==i&&o.find("cq-swatch")[0].setColor(e[a],!1))}var i=this.helper.settings;a("cu",i.chartTypes["Candle/Bar"].up,"color","color"),a("cd",i.chartTypes["Candle/Bar"].down,"color","color"),a("wu",i.chartTypes["Candle/Bar"].up,"wick","color"),a("wd",i.chartTypes["Candle/Bar"].down,"wick","color"),a("bu",i.chartTypes["Candle/Bar"].up,"border","color"),a("bd",i.chartTypes["Candle/Bar"].down,"border","color"),a("lc",i.chartTypes.Line,"color","color"),a("mb",i.chartTypes.Mountain,"basecolor","color"),a("mc",i.chartTypes.Mountain,"color","color"),a("bg",i.chart.Background,"color","color"),a("gl",i.chart["Grid Lines"],"color","color"),a("dd",i.chart["Grid Dividers"],"color","color"),a("at",i.chart["Axis Text"],"color","color"),e||(e="My Theme"),this.node.find("cq-action input").val(e)},w.UI.ThemeDialog=document.registerElement("cq-theme-dialog",C);var q={prototype:Object.create(w.UI.BaseComponent)};q.prototype.setColor=function(t){"Hollow"!=t&&"No Border"!=t||(t="transparent",this.node.find("cq-swatch")[0].setColor("transparent",!1)),w.UI.containerExecute(this,"setValue",this.piece.obj,this.piece.field,t)},q.prototype.setBoolean=function(t){w.UI.containerExecute(this,"setValue",this.piece.obj,this.piece.field,t)},w.UI.ThemePiece=document.registerElement("cq-theme-piece",q);var k={prototype:Object.create(w.UI.ContextTag)};k.prototype.attachedCallback=function(){this.attached||(w.UI.ContextTag.attachedCallback.apply(this),this.attached=!0,this.builtInMenu=$(this).find("cq-themes-builtin"),this.builtInTemplate=this.builtInMenu.find("template"),this.customMenu=$(this).find("cq-themes-custom"),this.customTemplate=this.customMenu.find("template"))},k.prototype.initialize=function(t){this.params={},t&&(this.params=t),this.params.customThemes||(this.params.customThemes={}),this.params.builtInThemes||(this.params.builtInThemes={}),this.params.nameValueStore||(this.params.nameValueStore=new w.NameValueStore),t.id&&(this.id="themes_"+t.id);var a=this;this.params.nameValueStore?this.params.nameValueStore.get("CIQ.Themes.prototype.custom",function(t,e){!t&&e&&(a.params.customThemes=e),a.params.nameValueStore.get(a.id+"CIQ.Themes.prototype.current",function(t,e){!t&&e&&e.theme?a.loadTheme(e.theme):a.loadTheme(a.params.defaultTheme),a.configureMenu()})}):this.loadTheme(a.params.defaultTheme)},k.prototype.configureMenu=function(){function t(e,a){return function(t){e.loadBuiltIn(a),e.params.callback&&e.params.callback({theme:e.currentTheme}),e.persist("current")}}function e(e,a){return function(t){e.loadCustom(a),e.params.callback&&e.params.callback({theme:e.currentTheme}),e.persist("current")}}var a,i;this.builtInMenu.emptyExceptTemplate(),this.customMenu.emptyExceptTemplate();var o=this.params.builtInThemes;for(var n in o)a=o[n],(i=w.UI.makeFromTemplate(this.builtInTemplate)).text(a),this.makeTap(i[0],t(this,n)),this.builtInMenu.append(i);w.I18N.translateUI(null,this.builtInMenu[0]);var r=this.params.customThemes;for(var s in r)a=s,(i=w.UI.makeFromTemplate(this.customTemplate)).find("cq-label").text(a),this.makeTap(i.find("cq-item")[0],e(this,s)),i[0].close=function(t,e){return function(){t.removeTheme(e)}}(this,s),this.customMenu.append(i)},k.prototype.removeTheme=function(t){var e=!1;$("cq-themes").each(function(){delete this.params.customThemes[t],this.configureMenu(),e||(this.persist(),e=!0)})},k.prototype.persist=function(t){this.params.nameValueStore&&(t&&"current"!=t||this.params.nameValueStore.set(this.id+"CIQ.Themes.prototype.current",{theme:this.currentTheme}),t&&"custom"!=t||this.params.nameValueStore.set("CIQ.Themes.prototype.custom",this.params.customThemes))},k.prototype.addCustom=function(t,e){this.params.customThemes[t.name]=t,e===this&&(this.currentTheme=t.name),this.configureMenu(),this.persist()},k.prototype.reinitializeChart=function(t){this.context.stx.setThemeSettings(t?t.settings:null)},k.prototype.loadTheme=function(t){this.params.customThemes[t]?this.loadCustom(t):this.params.builtInThemes[t]?this.loadBuiltIn(t):this.loadBuiltIn(this.params.defaultTheme)},k.prototype.loadBuiltIn=function(t){this.currentLoadedBuiltIn&&$(this.context.topNode).removeClass(this.currentLoadedBuiltIn),$(this.context.topNode).addClass(t),this.currentLoadedBuiltIn=this.currentTheme=t,this.reinitializeChart()},k.prototype.loadCustom=function(t){this.currentLoadedBuiltIn&&$(this.context.topNode).removeClass(this.currentLoadedBuiltIn);var e=this.params.customThemes[t];e.builtIn&&$(this.context.topNode).addClass(e.builtIn),this.currentLoadedBuiltIn=e.builtIn,this.currentTheme=e.name,this.reinitializeChart(e)},k.prototype.newTheme=function(){var t=this;$("cq-theme-dialog").each(function(){this.open({context:t.context,initiatingMenu:t})})},w.UI.Themes=document.registerElement("cq-themes",k);var T={prototype:Object.create(w.UI.DialogContentTag)};T.prototype.removeTimezone=function(){w.ChartEngine.defaultDisplayTimeZone=null;var t=this.context.stx;t.displayZone=null,t.setTimeZone(),t.displayInitialized&&t.draw(),w.UI.DialogContentTag.close.apply(this)},T.prototype.open=function(t){w.UI.DialogContentTag.open.apply(this,arguments);var e=this.node,i=this;this.context=t.context;var o=this.context.stx,a=e.find("ul"),n=e.find(".ciq-btn");for(var r in this.template||(this.template=a.find("li.timezoneTemplate")[0].cloneNode(!0)),a.empty(),w.timeZoneMap){var s=r,c=o.translateIf(s),l=this.template.cloneNode(!0);l.style.display="block",l.innerHTML=c,w.safeClickTouch(l,d(s)),a.append(l)}var h=e.find(".currentUserTimeZone");if(o.displayZone){var p=o.displayZone;for(var u in w.timeZoneMap)w.timeZoneMap[u]===o.displayZone&&(p=u);h.text(o.translateIf("Current TimeZone is")+" "+o.translateIf(p)),n.show()}else h.text(o.translateIf("Your timezone is your current location")),n.hide();function d(a){return function(t){w.UI.DialogContentTag.close.apply(i);var e=w.timeZoneMap[a];w.ChartEngine.defaultDisplayTimeZone=e,o.setTimeZone(o.dataZone,e),o.chart.symbol&&o.draw()}}},w.UI.TimezoneDialog=document.registerElement("cq-timezone-dialog",T);var I={prototype:Object.create(w.UI.ContextTag)};I.prototype.setContext=function(t){this.currentValue|=!1,this.params.obj=this.context.stx.layout;var e=this.node.attr("cq-member");e&&(this.params.member=e);var a=this.node.attr("cq-action");a&&(this.params.action=a);var i=this.node.attr("cq-value");i&&(this.params.value=i);var o=this.node.attr("cq-toggles");o&&(this.params.toggles=o.split(","));for(var n=0;n<this.params.toggles.length;n++)"null"==this.params.toggles[n]&&(this.params.toggles[n]=null);this.begin()},I.prototype.attachedCallback=function(){this.attached||(this.params={member:null,obj:null,action:"class",value:"active",toggles:[],callbacks:[]},w.UI.ContextTag.attachedCallback.apply(this),this.attached=!0)},I.prototype.registerCallback=function(t,e){!1!==e&&(e=!0),this.params.callbacks.push(t),e&&t.call(this,this.currentValue)},I.prototype.updateFromBinding=function(t){if(this.currentValue=t.obj[t.member],this.params.callbacks.length)for(var e=0;e<this.params.callbacks.length;e++)this.params.callbacks[e].call(this,this.currentValue);else"class"==this.params.action&&(this.currentValue?this.node.addClass(this.params.value):this.node.removeClass(this.params.value));"crosshair"==t.member&&!1===this.currentValue&&this.context.stx.doDisplayCrosshairs()},I.prototype.set=function(t){if(this.params.member)this.params.obj[this.params.member]=t;else{this.currentValue=t;for(var e=0;e<this.params.callbacks.length;e++)this.params.callbacks[e].call(this,this.currentValue)}},I.prototype.begin=function(){var o=this,n=this.context.stx;this.params.member&&w.UI.observe({selector:this.node,obj:this.params.obj,member:this.params.member,action:"callback",value:function(t){o.updateFromBinding(t)}}),this.node.stxtap(function(){var t=o.params.toggles,e=o.params.obj;if(1<t.length){for(var a=0;a<t.length;a++){var i=t[a];if(o.currentValue==i){a<t.length-1?o.set(t[a+1]):o.set(t[0]);break}}a==t.length&&o.set(t[0])}else o.currentValue?o.set(!1):o.set(!0);n.draw(),e===n.layout&&n.changeOccurred("layout")})},w.UI.Toggle=document.registerElement("cq-toggle",I);var S={prototype:Object.create(w.UI.ContextTag)};S.prototype.attachedCallback=function(){this.attached||(w.UI.ContextTag.attachedCallback.apply(this),this.node=$(this),this.params={toolSelection:this.node.find("*[cq-current-tool]"),lineSelection:this.node.find("*[cq-line-style]"),fontSizeSelection:this.node.find("*[cq-font-size]"),fontFamilySelection:this.node.find("*[cq-font-family]"),fontStyleToggle:this.node.find("cq-annotation-italic"),fontWeightToggle:this.node.find("cq-annotation-bold"),axisLabelToggle:this.node.find("cq-axis-label .ciq-checkbox"),fillColor:this.node.find("cq-fill-color").not("cq-cvp-controller"),lineColor:this.node.find("cq-line-color").not("cq-cvp-controller"),cvpControllers:this.node.find("cq-cvp-controller")},this.params.cvpControllers.prop("toolbar",this),this.noToolSelectedText="",this.attached=!0)},S.prototype.defaultElements=function(t){var e=[];for(var a in t)"color"==a?e.push("cq-line-color"):"fillColor"==a?e.push("cq-fill-color"):"pattern"==a||"lineWidth"==a?e.push("cq-line-style"):"axisLabel"==a?e.push("cq-axis-label"):"font"==a?e.push("cq-annotation"):"parameters"==a&&e.push("cq-clickable");return e},S.prototype.setContext=function(t){this.noToolSelectedText=$(this.params.toolSelection).text(),this.sync()},S.prototype.sync=function(t){var e=this.context.stx;t?e.currentVectorParameters=w.extend(e.currentVectorParameters||{},t):t=e.currentVectorParameters,this.setLine(null,t.lineWidth,t.pattern);var a=e.canvasStyle("stx_annotation"),i=t.annotation.font.size||a.fontSize;this.setFontSize(null,i);var o=t.annotation.font.family||a.fontFamily;this.setFontFamily(null,o);var n=t.annotation.font.style||a.fontStyle;$(this.params.fontStyleToggle)["italic"===n?"addClass":"removeClass"]("ciq-active");var r=t.annotation.font.weight||a.fontWeight;$(this.params.fontWeightToggle)["bold"===r||700<=r?"addClass":"removeClass"]("ciq-active"),$(this.params.axisLabelToggle)[t.axisLabel?"addClass":"removeClass"]("ciq-active"),this.getFillColor({node:$(this.params.fillColor)}),this.getLineColor({node:$(this.params.lineColor)}),$(this.params.cvpControllers).each(function(){this.sync(t)}),this.node.find("*[cq-toolbar-dirty]").removeClass("ciq-active")},S.prototype.emit=function(){var t=document.createEvent("Event");t.initEvent("change",!0,!0),this.node.find("*[cq-toolbar-dirty]").addClass("ciq-active"),this.dispatchEvent(t)},S.prototype.noTool=function(){var t=this.context.stx;t.changeVectorType(null),t.layout.crosshair&&(t.layout.crosshair=!1,t.changeOccurred("layout"),t.doDisplayCrosshairs()),t.preferences.magnet&&this.toggleMagnet(this),$(this.params.toolSelection).text(this.noToolSelectedText),$(this.params.toolSelection).attr("cq-current-tool",""),this.node.find("*[cq-section]").removeClass("ciq-active"),this.emit()},S.prototype.crosshairs=function(t){var e=this.context.stx;$(this.params.toolSelection).html($(t.node).html()),e.changeVectorType(null),e.layout.crosshair=!0,e.doDisplayCrosshairs(),e.findHighlights(!1,!0),e.changeOccurred("layout"),e.draw(),e.updateChartAccessories(),this.node.find("*[cq-section]").removeClass("ciq-active"),this.emit()},S.prototype.toggleMagnet=function(t){var e=$(t.node),a=this.context.stx;a.preferences.magnet?(e.removeClass("active"),a.preferences.magnet=!1):(e.addClass("active"),a.preferences.magnet=!0),w.clearCanvas(a.chart.tempCanvas,a)},S.prototype.clearDrawings=function(){this.context.stx.clearDrawings(null,!1)},S.prototype.restoreDefaultConfig=function(t,e){var a=this.context.stx;w.Drawing.restoreDefaultConfig(a,a.currentVectorParameters.vectorType,e),this.node.find("*[cq-toolbar-action='restore']").removeClass("ciq-active"),this.sync()},S.prototype.saveConfig=function(){var t=this.context.stx;w.Drawing.saveConfig(t,t.currentVectorParameters.vectorType),this.node.find("*[cq-toolbar-action='restore']").addClass("ciq-active"),this.sync()},S.prototype.tool=function(t,e){if(e||(e=t.node.getAttribute("cq-tool")),e){var a=this.context.stx;a.clearMeasure(),a.changeVectorType(e),$(this.params.toolSelection).html($(t.node).html()),$(this.params.toolSelection).attr("cq-current-tool",e),this.node.find("*[cq-section]").removeClass("ciq-active");var i=w.Drawing.getDrawingParameters(a,e);if(i){this.node.find("*[cq-toolbar-action='save']").addClass("ciq-active"),drawingPrefs=a.preferences.drawings,drawingPrefs&&drawingPrefs[e]&&this.node.find("*[cq-toolbar-action='restore']").addClass("ciq-active"),"fibtimezone"===e&&delete i.parameters;var o=$(this.params.lineSelection).parent().find(".ciq-none");o.hide();for(var n=this.defaultElements(i),r=0;r<n.length;r++)$(this.node).find(n[r]).addClass("ciq-active"),"cq-fill-color"==n[r]&&o.show();for(n=w.Drawing[e].prototype.$controls,r=0;n&&r<n.length;r++)$(this.node).find(n[r]).addClass("ciq-active")}this.sync()}},S.prototype.setLine=function(t,e,a){var i=this.context.stx;i.currentVectorParameters.lineWidth=e,i.currentVectorParameters.pattern=a,this.setFibs(e,a),this.currentLineSelectedClass&&$(this.params.lineSelection).removeClass(this.currentLineSelectedClass),this.currentLineSelectedClass="ciq-"+a+"-"+parseInt(e,10),"none"==a?this.currentLineSelectedClass=null:$(this.params.lineSelection).addClass(this.currentLineSelectedClass),this.emit()},S.prototype.setFibs=function(t,e){var a=this.context.stx.currentVectorParameters.fibonacci;if(a){for(var i=0;i<a.fibs.length;i++)a.fibs[i].parameters.lineWidth=t,a.fibs[i].parameters.pattern=e;a.timezone.parameters.lineWidth=t,a.timezone.parameters.pattern=e}},S.prototype.setFontSize=function(t,e){this.context.stx.currentVectorParameters.annotation.font.size=e,$(this.params.fontSizeSelection).text(e),this.emit()},S.prototype.setFontFamily=function(t,e){this.context.stx.currentVectorParameters.annotation.font.family="Default"==e?null:e,$(this.params.fontFamilySelection).text(e),this.emit()},S.prototype.toggleFontStyle=function(t,e){var a=this.context.stx;"italic"==e?"italic"==a.currentVectorParameters.annotation.font.style?(a.currentVectorParameters.annotation.font.style=null,$(t.node).removeClass("ciq-active")):(a.currentVectorParameters.annotation.font.style="italic",$(t.node).addClass("ciq-active")):"bold"==e&&("bold"==a.currentVectorParameters.annotation.font.weight?(a.currentVectorParameters.annotation.font.weight=null,$(t.node).removeClass("ciq-active")):(a.currentVectorParameters.annotation.font.weight="bold",$(t.node).addClass("ciq-active"))),this.emit()},S.prototype.toggleAxisLabel=function(t){var e=this.context.stx;!0===e.currentVectorParameters.axisLabel?(e.currentVectorParameters.axisLabel=!1,$(t.node).removeClass("ciq-active")):(e.currentVectorParameters.axisLabel=!0,$(t.node).addClass("ciq-active")),this.emit()},S.prototype.getFillColor=function(t){var e=t.node,a=this.context.stx.currentVectorParameters.fillColor;"transparent"!=a&&"auto"!=a||(a=""),$(e).css({"background-color":a})},S.prototype.pickFillColor=function(t){var e=t.node,a=$("cq-color-picker");if(a.length){var i=a[0],o=this;i.callback=function(t){o.context.stx.currentVectorParameters.fillColor=t,o.getFillColor({node:e}),o.emit()},i.display({node:e})}else console.log("DrawingToolbar.prototype.pickFillColor: no ColorPicker available")},S.prototype.getLineColor=function(t){var e=t.node,a=this.context.stx.currentVectorParameters.currentColor;"transparent"!=a&&"auto"!=a||(a=""),$(e).css({"background-color":a})},S.prototype.pickLineColor=function(t){var e=t.node,a=$("cq-color-picker");if(a.length){var i=a[0],o=this;i.callback=function(t){o.context.stx.currentVectorParameters.currentColor=t,o.getLineColor({node:e}),o.emit()};var n=$(e).attr("cq-overrides");n&&(n=n.split(",")),i.display({node:e,overrides:n})}else console.log("DrawingToolbar.prototype.pickLineColor: no ColorPicker available")},w.UI.DrawingToolbar=document.registerElement("cq-toolbar",S);var U={prototype:Object.create(w.UI.ContextTag)},M=function(e){return{configurable:!0,enumerable:!1,get:function(){return this.context.stx.currentVectorParameters[e+this._scope]},set:function(t){this.context.stx.currentVectorParameters[e+this._scope]=t}}};Object.defineProperties(U.prototype,{active:M("active"),color:M("color"),lineWidth:M("lineWidth"),pattern:M("pattern")}),U.prototype.createdCallback=function(){w.UI.ContextTag.createdCallback.call(this),Object.defineProperty(this,"_scope",{configurable:!0,enumerable:!1,value:this.getAttribute("cq-cvp-header")||"",writable:!1})},U.prototype.attachedCallback=function(){if(!this.attached){var t=document.querySelector("template[cq-cvp-controller]");if(0===this.children.length&&t){var e=document.importNode(t.content,!0),a=e.querySelector(".ciq-heading");a&&(a.innerHTML=this._scope),this.appendChild(e)}w.UI.ContextTag.attachedCallback.call(this),this.attached=!0}},U.prototype.setContext=function(t){this.setStyle()},U.prototype.emit=function(t,e){if(this.toolbar)this.toolbar.emit(t,e);else if("function"==typeof CustomEvent)this.dispatchEvent(new CustomEvent(t,{bubbles:!0,cancelable:!0,detail:e}));else{var a=document.createEvent("CustomEvent");a.initCustomEvent(t,!0,!0,e),this.dispatchEvent(a)}},U.prototype.sync=function(t){var e=t["active"+this._scope],a=t["color"+this._scope],i=t["lineWidth"+this._scope],o=t["pattern"+this._scope],n="ciq-active",r=$(this).find(".ciq-checkbox");e?r.addClass(n):r.removeClass(n),this.active=!!e,this.color=a||"",this.getColor({}),this.setStyle(null,i,o)},U.prototype.toggleActive=function(t){var e=$(t.node),a="ciq-active";this.active?(this.active=!1,e.removeClass(a)):(this.active=!0,e.addClass(a)),this.emit("change",{active:this.active})},U.prototype.setStyle=function(t,e,a){e=e||"1",a=a||"dotted",this.lineWidth=parseInt(e,10),this.pattern=a;var i=$(this).find("*[cq-cvp-line-style]");this.lineStyleClassName&&i.removeClass(this.lineStyleClassName),a&&"none"!==a?(this.lineStyleClassName="ciq-"+a+"-"+this.lineWidth,i.addClass(this.lineStyleClassName)):this.lineStyleClassName=null,this.emit("change",{lineWidth:e,pattern:a})},U.prototype.getColor=function(t){var e=t.node||$(this).find("cq-line-color"),a=this.color;"transparent"!=a&&"auto"!=a||(a=""),$(e).css({"background-color":a})},U.prototype.pickColor=function(e){var t=$("cq-color-picker")[0],a=this,i=$(e.node).attr("cq-overrides");if(!t)return console.error("CVPController.prototype.pickColor: no <cq-color-picker> available");i&&(e.overrides=i.split(",")),t.callback=function(t){a.color=t,a.getColor(e),a.emit("change",{color:t})},t.display(e)},w.UI.CVPController=document.registerElement("cq-cvp-controller",U);var E={prototype:Object.create(w.UI.ContextTag)};E.prototype.attachedCallback=function(){this.attached||(w.UI.ContextTag.attachedCallback.apply(this),this.attached=!0)},E.prototype.initialize=function(t){this.params=t||{},this.params.viewObj||(this.params.viewObj={views:[]}),this.params.nameValueStore||(this.params.nameValueStore=new w.NameValueStore),this.params.template||(this.params.template="template[cq-view]"),this.params.template=this.node.find(this.params.template),this.params.template.detach();var a=this;this.params.nameValueStore.get("stx-views",function(t,e){!t&&e&&(a.params.viewObj.views=e),a.params.cb&&a.params.cb.call(a),a.renderMenu()})},E.prototype.renderMenu=function(){var t=$(this.node),i=this,o=i.context.stx;function e(a){return function(t){t.stopPropagation();var e=!1;$("cq-views").each(function(){this.params.viewObj.views.splice(a,1),e||(this.params.nameValueStore.set("stx-views",i.params.viewObj.views),e=!0),this.renderMenu()})}}function a(a){return function(t){t.stopPropagation(),i.uiManager.closeMenu(),i.context.loader&&i.context.loader.show();var e=w.first(i.params.viewObj.views[a]);setTimeout(function(){o.importLayout(i.params.viewObj.views[a][e],{managePeriodicity:!0,preserveTicksAndCandleWidth:!0,cb:function(){o.changeOccurred("layout"),i.context.loader&&i.context.loader.hide()}})},10)}}t.find("cq-views-content cq-item").remove();for(var n=0;n<this.params.viewObj.views.length;n++){var r=w.first(i.params.viewObj.views[n]);if("recent"!=r){var s=w.UI.makeFromTemplate(this.params.template),c=s.find("cq-label"),l=s.find("div");c.length&&(c.addClass("view-name-"+r),c.prepend(r)),l.length&&l.stxtap(e(n)),this.makeTap(s[0],a(n)),t.find("cq-views-content").append(s)}}var h=t.find("cq-view-save");if(h){var p=this.context;this.makeTap(h.find("cq-item")[0],function(t){$("cq-view-dialog").each(function(){$(this).find("input").val(""),this.open({context:p})})})}this.params.renderCB&&this.params.renderCB(t)},w.UI.Views=document.registerElement("cq-views",E);var D={};D.prototype=Object.create(w.UI.ContextTag),D.prototype.attachedCallback=function(){this.attached||(w.UI.ContextTag.attachedCallback.apply(this),this.attached=!0)},D.prototype.initialize=function(t){this.params=t||{},this.alwaysDisplayDialog=this.params.alwaysDisplayDialog||!1,this.excludedStudies=this.params.excludedStudies||[],this.params.template||(this.params.template="template"),this.params.template=this.node.find(this.params.template),this.params.template.detach(),this.renderMenu();var e=this;w.UI.observe({obj:w.Studies.studyLibrary,action:"callback",value:function(){e.renderMenu()}})},D.prototype.renderMenu=function(){var t,e=this.context.stx,a=[];for(var i in w.Studies.studyLibrary)!(t=w.Studies.studyLibrary[i])||this.excludedStudies[i]||this.excludedStudies[t.name]||void 0!==t.siqList||(t.name||(t.name=i),a.push(i));a.sort(function(t,e){var a=w.Studies.studyLibrary[t],i=w.Studies.studyLibrary[e];return a.name<i.name?-1:a.name>i.name?1:0});for(var o=$(this.node),n=this,r=function(e,t){return function(t){!function(t,o){var e=n.context.stx;function a(t,e,a){if(!0===t)return h(e,a),!0;if("object"==typeof t)for(var i in t)if(i==o&&t[i])return h(e,a),!0}if(!a(n.params.dialogBeforeAddingStudy,{stx:e,name:o},!0)){var i=w.Studies.addStudy(e,o);a(n.alwaysDisplayDialog,{sd:i,stx:e})}}(t.target,e),o.resize()}},s=o.find("cq-studies-content");0<s.length&&s[0].firstChild;)s[0].removeChild(s[0].firstChild);for(var c=0;c<a.length;c++){var l=w.UI.makeFromTemplate(this.params.template);t=w.Studies.studyLibrary[a[c]],l.append(w.translatableTextNode(e,t.name)),this.makeTap(l[0],r(a[c],this.context)),o.find("cq-studies-content").append(l)}function h(t,e){t.context=n.context,$("cq-study-dialog").each(function(){this.addWhenDone=e,this.open(t)})}},w.UI.StudyMenu=function(){throw new Error("The CIQ.UI.StudyMenu helper function has been replaced by a <cq-studies> webcomponent.")},w.UI.StudiesComponent=document.registerElement("cq-studies",D);var P={prototype:Object.create(HTMLElement.prototype)};P.prototype.createdCallback=function(){this.node=$(this),this.active=!1},P.prototype.attachedCallback=function(){if(!this.attached&&(this.uiManager=$("cq-ui-manager"),0<this.uiManager.length&&(this.uiManager=this.uiManager[0]),this.attached=!0,!this.node.attr("readonly"))){var e=this,t=this.node[0];this.node.stxtap(function(t){e.tap(t)}),t.addEventListener("stxtap",function(t){e.captureTap(t)},!0)}},P.prototype.open=function(t){for(var e=this.uiManager.activeMenuStack,a=0;a<e.length;a++)if(e[a]===this)return;this.uiManager.openMenu(this,t)},P.prototype.close=function(){this.uiManager.closeMenu(this)},P.prototype.lift=function(){for(var t=this.lifts=this.uiManager.findLifts(this),e=0;e<t.length;e++)this.uiManager.lift(t[e])},P.prototype.unlift=function(){var t=this.lifts;if(t){for(var e=0;e<t.length;e++)this.uiManager.restoreLift(t[e]);this.lifts=null}},P.prototype.show=function(t){this.active||(this.active=!0,this.node.addClass("stxMenuActive"),this.lift(),this.node.find("cq-scroll").each(function(){this.resize()}))},P.prototype.hide=function(){this.active&&(this.unlift(),this.node.removeClass("stxMenuActive"),this.active=!1,$(this).find("input").each(function(){this==document.activeElement&&this.blur()}))},P.prototype.captureTap=function(t){var e=$(t.target).parents().addBack();this.noClose=e.filter(function(){var t=$(this).attr("cq-no-close");return void 0!==t&&!1!==t}).length,this.noClose||(this.noClose=e.filter(function(){return $(this).is("cq-separator,cq-heading")}).length)},P.prototype.tap=function(t){var e=this.uiManager;if(this.active)t.stopPropagation(),this.noClose||e.closeMenu(this);else if(!this.active){if(t.stopPropagation(),$(t.target).parents("cq-menu-dropdown").length)return;for(var a=!1,i=this.node.parents("cq-menu,cq-dialog"),o=0;o<i.length;o++)i[o].active&&(a=!0);a||e.closeMenu(),this.open()}},w.UI.Menu=document.registerElement("cq-menu",P);var j={prototype:Object.create(w.UI.BaseComponent)};w.UI.addInheritance(j,w.UI.Scroll),j.prototype.createdCallback=function(){if(this.ownerDocument===document){var t=$(this);w.UI.BaseComponent.createdCallback.call(this),void 0===t.attr("cq-no-scroll")&&w.UI.Scroll.prototype.createdCallback.call(this)}},j.prototype.attachedCallback=function(){if(!this.attached){var t=$(this);this.noMaximize=!0,w.UI.BaseComponent.attachedCallback.call(this),this.attached=!1,void 0===t.attr("cq-no-scroll")&&w.UI.Scroll.prototype.attachedCallback.call(this),this.attached=!0}},w.UI.MenuDropDown=document.registerElement("cq-menu-dropdown",j);var O={prototype:Object.create(w.UI.ContextTag)};O.prototype.tap=function(t){var e=this.context;$("cq-share-dialog").each(function(){this.open({context:e})})},w.UI.ShareButton=document.registerElement("cq-share-button",O);var B={prototype:Object.create(w.UI.DialogContentTag)};B.prototype.setState=function(t){this.node.find("cq-share-create").css({display:"none"}),this.node.find("cq-share-generating").css({display:"none"}),this.node.find("cq-share-uploading").css({display:"none"}),this.node.find("cq-share-"+t).css({display:"inline-block"})},B.prototype.close=function(){$("cq-share-dialog .share-link-div").html(""),w.UI.DialogContentTag.close.apply(this)},B.prototype.share=function(){var s=this.context.stx,c=this;this.setState("generating"),$("cq-share-dialog .share-link-div").html(""),w.UI.bypassBindings=!0,w.Share.createImage(s,{hide:[".stx_chart_controls",".stx-btn-panel",".stx_jump_today",".stx-baseline-handle"]},function(t){w.UI.bypassBindings=!1;var e=w.uniqueID(),a="https://share.chartiq.com",i=s.getStartDateOffset(),o={layout:s.exportLayout(),drawings:s.exportDrawings(),xOffset:i,startDate:s.chart.dataSegment[i].Date,endDate:s.chart.dataSegment[s.chart.dataSegment.length-1].Date,id:e,symbol:s.chart.symbol},n=a+"/upload/"+e,r={id:e,image:t,config:o};c.setState("uploading"),w.Share.uploadImage(t,n,r,function(t,e){c.setState("create"),null!==t?w.alert("error: "+t):$("cq-share-dialog .share-link-div").html(a+e)})})},w.UI.ShareDialog=document.registerElement("cq-share-dialog",B);var A={prototype:Object.create(w.UI.DialogContentTag)};A.prototype.open=function(t){w.UI.DialogContentTag.open.apply(this,arguments);var a=this.context.stx,e=t.aggregationType,i={kagi:{title:"Set Reversal Percentage"},renko:{title:"Set Range"},linebreak:{title:"Set Price Lines"},rangebars:{title:"Set Range"},pandf:{title:"Set Point & Figure Parameters"}};a.layout.aggregationType!=e&&a.setAggregationType(e);var o=i[e],n=this.node;for(var r in n.find(".title").text(a.translateIf(o.title)),i)n.find(".ciq"+r).css(e===r?{display:""}:{display:"none"});n.find(".ciq"+e+" input").each(function(){var t=this.name;"box"!=t&&"reversal"!=t||(t="pandf."+t);var e=w.deriveFromObjectChain(a.layout,t);e&&!e.obj[e.member]&&a.chart.defaultChartStyleConfig[this.name]&&$(this).val(a.chart.defaultChartStyleConfig[this.name])})},w.UI.AggregationDialog=document.registerElement("cq-aggregation-dialog",A);var L={prototype:Object.create(w.UI.Dialog.prototype)};L.prototype.createdCallback=function(){w.UI.Dialog.prototype.createdCallback.apply(this),this.params={colorMap:[["#ffffff","#e1e1e1","#cccccc","#b7b7b7","#a0a0a5","#898989","#707070","#626262","#555555","#464646","#363636","#262626","#1d1d1d","#000000"],["#f4977c","#f7ac84","#fbc58d","#fff69e","#c4de9e","#85c99e","#7fcdc7","#75d0f4","#81a8d7","#8594c8","#8983bc","#a187bd","#bb8dbe","#f29bc1"],["#ef6c53","#f38d5b","#f8ae63","#fff371","#acd277","#43b77a","#2ebbb3","#00bff0","#4a8dc8","#5875b7","#625da6","#8561a7","#a665a7","#ee6fa9"],["#ea1d2c","#ee652e","#f4932f","#fff126","#8ec648","#00a553","#00a99c","#00afed","#0073ba","#0056a4","#323390","#66308f","#912a8e","#e9088c"],["#9b0b16","#9e4117","#a16118","#c6b920","#5a852d","#007238","#00746a","#0077a1","#004c7f","#003570","#1d1762","#441261","#62095f","#9c005d"],["#770001","#792e03","#7b4906","#817a0b","#41661e","#005827","#005951","#003b5c","#001d40","#000e35","#04002c","#19002b","#2c002a","#580028"]]}},L.prototype.attachedCallback=function(){if(!this.attached){w.UI.Dialog.prototype.attachedCallback.apply(this);var t=$(this),e=t.attr("cq-colors");if(e){e=e.split(",");var a=Math.ceil(Math.sqrt(e.length));this.params.colorMap=[],console.log("this.params.colorMap=[]"),console.log(typeof this.params.colorMap);for(var i=0,o=[],n=0;n<e.length;n++)a<=i&&(i=0,this.params.colorMap.push(o),o=[]),o.push(e[n]),i++;this.params.colorMap.push(o)}this.cqOverrides=t.find("cq-overrides"),this.template=this.cqOverrides.find("template"),this.initialize(),this.attached=!0}},L.prototype.setColors=function(t){this.params.colorMap=t,this.initialize()},L.prototype.initialize=function(){function t(t,e){return function(){t.pickColor(e)}}this.picker=$(this),this.colors=this.picker.find("cq-colors"),this.colors.length||(this.colors=this.picker),this.colors.empty();for(var e=0;e<this.params.colorMap.length;e++)for(var a=this.params.colorMap[e],i=$("<UL></UL>").appendTo(this.colors),o=0;o<a.length;o++){var n=$("<LI></LI>").appendTo(i),r=$("<SPAN></SPAN>").appendTo(n);r.css({"background-color":a[o]}),r.stxtap(t(this,a[o]))}},L.prototype.pickColor=function(t){this.callback&&this.callback(t),this.close()},L.prototype.resize=function(){},L.prototype.display=function(t){var e=$(t.node),a=e[0].getBoundingClientRect();this.picker.css({top:"0px",left:"0px"});var i=this.parentNode.getBoundingClientRect(),o=a.left-i.left+e.width()+10,n=a.top-i.top+5,r=$(document).width(),s=this.picker.width();r<o+s&&(o=r-s-20);var c=$(document).height(),l=this.picker.height();if(c<n+l&&(n=c-l-20),this.picker.css({left:o+"px",top:n+"px"}),this.cqOverrides.emptyExceptTemplate(),t.overrides&&this.template.length)for(var h=0;h<t.overrides.length;h++){var p=t.overrides[h],u=w.UI.makeFromTemplate(this.template,!0);u.text(p),u.stxtap(function(t,e){return function(){t.pickColor(e)}}(this,p))}this.picker.hasClass("stxMenuActive")?this.context.e&&this.context.e.stopPropagation():this.picker[0].open({context:w.UI.getMyContext(this)})},w.UI.ColorPicker=document.registerElement("cq-color-picker",L);var V={prototype:Object.create(w.UI.DialogContentTag)};V.prototype.setContext=function(t){w.UI.DialogContentTag.setContext.call(this,t),t.advertiseAs(this,"StudyDialog")},V.prototype.attachedCallback=function(){if(!this.attached){w.UI.DialogContentTag.attachedCallback.apply(this);var t=$(this);this.inputTemplate=t.find("template[cq-study-input]"),this.outputTemplate=t.find("template[cq-study-output]"),this.parameterTemplate=t.find("template[cq-study-parameters]"),this.attached=!0,this.queuedUpdates={}}},V.prototype.hide=function(){w.isEmpty(this.queuedUpdates)||(this.helper.updateStudy(this.queuedUpdates),this.queuedUpdates={}),this.node.find("cq-menu").each(function(){this.unlift&&this.unlift()}),this.node.find("cq-swatch").each(function(){this.colorPicker&&this.colorPicker.close()})},V.prototype.setChangeEvent=function(t,e,a){var i=this;t.change(function(){var t={};t[e]={},t[e][a]=this.value,"checkbox"!=this.type&&"radio"!=this.type||(t[e][a]=this.checked),i.updateStudy(t)})},V.prototype.updateStudy=function(t){$(this).find(":invalid").length||(this.addWhenDone?w.extend(this.queuedUpdates,t):this.helper.libraryEntry.deferUpdate?(w.extend(this.queuedUpdates,{inputs:t.inputs}),this.helper.updateStudy({outputs:t.outputs,parameters:t.parameters})):this.helper.updateStudy(t))},V.prototype.setSelectOption=function(t,e){var a=$(t.node),i=a.attr("name"),o=a.attr("value"),n=$(a[0].cqMenuWrapper);n.find("cq-selected").text(this.helper.stx.translateIf(o)),n[0].fieldValue=o,e||(e="inputs");var r={};r[e]={},r[e][i]=o,this.updateStudy(r)},V.prototype.open=function(t){w.UI.DialogContentTag.open.apply(this,arguments),t.axisSelect=this.hasAttribute("cq-study-axis"),t.panelSelect=this.hasAttribute("cq-study-panel"),this.helper=new w.Studies.DialogHelper(t);var e=$(this);e.find(".title").text(this.helper.title);var a,c=this;function i(t,e,a,i){var o=w.UI.makeFromTemplate(c.menuTemplate),n=o.find("cq-menu-dropdown");for(var r in a){var s=$("<cq-item></cq-item>");s.text(a[r]),s.attr("stxtap","StudyDialog.setSelectOption('"+i+"')"),n.append(s),s[0].cqMenuWrapper=n.parents("cq-menu")[0],s.attr("name",t),s.attr("value",r),s[0].context=c.context}return o.find("cq-selected").text(c.helper.stx.translateIf(e)),o}var o,n,r,s,l=e.find("cq-study-inputs");for(l.empty(),o=0;o<this.helper.inputs.length;o++){var h=this.helper.inputs[o],p=w.UI.makeFromTemplate(this.inputTemplate,l);this.menuTemplate=p.find("template[cq-menu]"),p.find(".ciq-heading").text(h.heading),p[0].fieldName=h.name;var u,d=null;if(a=this.helper.attributes[h.name],"number"==h.type)for(u in(d=$("<input>")).attr("type","number"),d.val(h.value),this.setChangeEvent(d,"inputs",h.name),a){var m=a[u];(w.isIE||w.isEdge)&&"step"==u&&Math.floor(m)!=m&&(m="any"),d.attr(u,m)}else if("text"==h.type||"date"==h.type||"time"==h.type)for(u in(d=$("<input>")).attr("type",w.UI.supportedInputType(h.type)),"date"==h.type?d.val(((r=(r=h.value).replace(/-/g,"")).search(/^\d{8}$/)||(r=r.substring(0,4)+"-"+r.substring(4,6)+"-"+r.substring(6,8)),r)):"time"==h.type?d.val(((n=(n=h.value).replace(/:/g,"")).search(/^\d{4,6}$/)||(n=n.substring(0,2)+":"+n.substring(2,4)+(4==n.length?"":":"+n.substring(4,6))),n)):d.val(h.value),this.setChangeEvent(d,"inputs",h.name),a)d.attr(u,a[u]);else if("select"==h.type)d=i(h.name,h.value,h.options,"inputs"),a&&a.readonly&&d.attr("readonly",a.readonly);else if("checkbox"==h.type)for(u in(d=$("<input>")).attr("type","checkbox"),h.value&&d.prop("checked",!0),this.setChangeEvent(d,"inputs",h.name),a)d.attr(u,a[u]);a&&a.hidden&&p.hide(),d&&p.find(".stx-data").append(d)}var f=e.find("cq-study-outputs");for(f.empty(),o=0;o<this.helper.outputs.length;o++){var v=this.helper.outputs[o],g=w.UI.makeFromTemplate(this.outputTemplate,f);g[0].initialize({studyDialog:this,output:v.name,params:t}),g.find(".ciq-heading").text(v.heading),g.find(".ciq-heading")[0].fieldName=v.name,s=g.find("cq-swatch");var y=v.color;"object"==typeof y&&(y=y.color),s[0].setColor(y,!1)}var b=e.find("cq-study-parameters");for(b.empty(),o=0;o<this.helper.parameters.length;o++){var x=this.helper.parameters[o],C=w.UI.makeFromTemplate(this.parameterTemplate,b);if(this.menuTemplate=C.find("template[cq-menu]"),this.menuTemplate.length||!x.options){C.find(".ciq-heading").text(x.heading),s=C.find("cq-swatch");var q,k=$("<input>");if(a={},x.defaultValue.constructor==Boolean)for(q in k.attr("type","checkbox"),x.value&&k.prop("checked",!0),this.setChangeEvent(k,"parameters",x.name+"Enabled"),s.remove(),a=this.helper.attributes[x.name+"Enabled"])k.attr(q,a[q]);else if(x.defaultValue.constructor==String){var T=x.name;for(q in x.defaultColor?(C[0].initialize({studyDialog:this,parameter:x.name+"Color",params:t}),s[0].setColor(x.color,!1),T+="Value"):s.remove(),x.options?k=i(T,x.value,x.options,"parameters"):k.val(x.value),a=this.helper.attributes[T])k.attr(q,a[q])}else{if(x.defaultValue.constructor!=Number)continue;for(q in k.attr("type","number"),k.val(x.value),this.setChangeEvent(k,"parameters",x.name+"Value"),C[0].initialize({studyDialog:this,parameter:x.name+"Color",params:t}),s[0].setColor(x.color,!1),a=this.helper.attributes[x.name+"Value"]){var I=a[q];(w.isIE||w.isEdge)&&"step"==q&&Math.floor(I)!=I&&(I="any"),k.attr(q,I)}}a&&a.hidden&&C.hide(),C.find(".stx-data").append(k)}else C.remove()}},V.prototype.close=function(){if(this.addWhenDone){var t=this.helper,e=w.Studies.addStudy(t.stx,t.name);w.isEmpty(this.queuedUpdates)||(t.sd=e,t.updateStudy(this.queuedUpdates),this.queuedUpdates={})}},w.UI.StudyDialog=document.registerElement("cq-study-dialog",V);var F={prototype:Object.create(w.UI.BaseComponent)};w.UI.StudyInput=document.registerElement("cq-study-input",F);var z={prototype:Object.create(w.UI.ModalTag)};z.prototype.setContext=function(t){},z.prototype.begin=function(){var e=this;function t(){e.showHide(),e.renderLegend()}e.template=e.node.find("template"),this.context.stx.addEventListener("layout",t),e.node[0].hasAttribute("cq-marker")&&e.node.stxtap(function(t){e.node.toggleClass("ciq-active")}),t()},z.prototype.showHide=function(){var t=this.node;for(var e in this.context.stx.layout.studies)if(!this.context.stx.layout.studies[e].customLegend)return void t.css({display:""});t.css({display:"none"})},z.prototype.renderLegend=function(){var r=this.context.stx;if(r.layout.studies){$(this.template).nextAll().remove();var t=void 0!==this.node.attr("cq-overlays-only"),e=void 0!==this.node.attr("cq-panel-only"),a=void 0!==this.node.attr("cq-custom-removal-only"),i=this.node.parents(".stx-holder"),o=null,n=this.node.attr("cq-marker-label");for(var s in i.length&&(o=i.attr("cq-panel-name")),r.layout.studies){var c=r.layout.studies[s];if(!c.customLegend&&(!a||c.study.customRemoval)&&(!e||c.panel==o)&&(!t||c.overlay||c.underlay)){var l=w.UI.makeFromTemplate(this.template,!0);l.find("cq-label").html(c.inputs.display);var h=l.find(".ciq-close");c.permanent?h.hide():h.stxtap(u(this,c));var p=l.find(".ciq-edit");p.length||(p=l.find("cq-label")),p.stxtap(d(this,s))}}void 0!==n&&(this.node.find("cq-marker-label").length||this.node.prepend("<cq-marker-label>"+n+"</cq-marker-label>"),this.node.find("cq-label").length?this.node.find("cq-marker-label").show():this.node.find("cq-marker-label").hide()),w.I18N.translateUI(null,this.node[0]),this.showHide()}function u(e,a){return function(t){setTimeout(function(){a.permanent||w.Studies.removeStudy(e.context.stx,a),e.node[0].hasAttribute("cq-marker")&&e.context.stx.modalEnd(),e.renderLegend()},0)}}function d(o,n){return function(t){var e=r.layout.studies[n];if(!e.permanent&&e.editFunction){t.stopPropagation(),o.uiManager.closeMenu();var a=o.context.getAdvertised("StudyEdit"),i={stx:r,sd:e,inputs:e.inputs,outputs:e.outputs,parameters:e.parameters};a.editPanel(i)}}}},w.UI.StudyLegend=document.registerElement("cq-study-legend",z);var N={prototype:Object.create(w.UI.BaseComponent)};N.prototype.initialize=function(t){this.params=t},N.prototype.setColor=function(t){if(this.params){var e={outputs:{}};e.outputs[this.params.output]={},e.outputs[this.params.output].color=t,this.params.studyDialog.updateStudy(e)}},w.UI.StudyOutput=document.registerElement("cq-study-output",N);var W={prototype:Object.create(w.UI.ContextTag)};return W.prototype.initialize=function(t){this.params=t},W.prototype.setColor=function(t){if(this.params){var e={parameters:{}};e.parameters[this.params.parameter]=t,this.params.studyDialog.updateStudy(e)}},w.UI.StudyParameter=document.registerElement("cq-study-parameter",W),t});